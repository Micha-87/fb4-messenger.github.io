require("mongoose").model("User");var mongoose=require("mongoose"),User=mongoose.model("User"),Message=mongoose.model("Message");module.exports={createUsers:function(e,n){var s=e.body;new User({nickname:s.nickname,name:s.name,email:s.email,password:s.password}).save(function(e){e?(n.status(504),n.end(e)):n.end()})},updateUserState:function(e,n){User.findById(e.params.id,function(s,a){s&&n.send(s),a.loggedin=e.body.loggedin,a.save(function(e){null===e?n.status(201).json(a):n.status(500).json({error:"save failed",err:e})})})},updateUserNickname:function(e,n){User.findById(e.params.id,function(s,a){s&&n.send(s);var o=a.nickname;a.nickname=e.body.nickname,a.save(function(e){null===e?n.status(201).json(a):n.status(500).json({error:"save failed",err:e})}),Message.find({},function(e,s){if(e)n.status(504),n.end(e);else for(let e=0;e<s.length;e++)s[e].sender===o?(s[e].sender=a.nickname,s[e].save(function(e){null===e||n.status(500).json({error:"save failed",err:e})})):s[e].receiver===o&&(s[e].receiver=a.nickname,s[e].save(function(e){null===e||n.status(500).json({error:"save failed",err:e})}))})})},updateUserName:function(e,n){User.findById(e.params.id,function(s,a){s&&n.send(s),a.name=e.body.name,a.save(function(e){null===e?n.status(201).json(a):n.status(500).json({error:"save failed",err:e})})})},updateUserEmail:function(e,n){User.findById(e.params.id,function(s,a){s&&n.send(s),a.email=e.body.email,a.save(function(e){null===e?n.status(201).json(a):n.status(500).json({error:"save failed",err:e})})})},updateUserPassword:function(e,n){User.findById(e.params.id,function(s,a){s&&n.send(s),a.password=e.body.password,a.save(function(e){null===e?n.status(201).json(a):n.status(500).json({error:"save failed",err:e})})})},seeResults:function(e,n){User.find({},function(e,s){e?(n.status(504),n.end(e)):n.end(JSON.stringify(s))})},findByEmail:function(e,n){User.find({email:e.params.email},function(e,s){e?(n.status(504),n.end(e)):n.end(JSON.stringify(s))})},findByNickname:function(e,n){User.find({nickname:e.params.nickname},function(e,s){e?(n.status(504),n.end(e)):n.end(JSON.stringify(s))})},delete:function(e,n){User.find({_id:e.params.id},function(n){n&&(e.status(504),e.end(),console.log(n))}).remove(function(e){console.log(e),e?n.end(e):n.end()})}};